<!DOCTYPE html>
<html lang="en" >
  <head>
    <meta charset="UTF-8">
    <title>Word Embedding</title>
  </head>

  <body>
    Hello World!
  </body>
</html>

<script>
var express = require('express');
var app = express();
var bodyParser = require('body-parser');
var mysql = require('mysql');
var mecab = require('mecab-ffi');

var client = mysql.createConnection({
    hostname : "127.0.0.1:3306",
    user : "root",
    password : "a123123",
    database : "qna"
});

app.use(bodyParser.json());

init();

function getIndex(Word_Arr,Count_Arr,Embedding_Arr,Word){
  var flag = 0;
  var i = 0;
  var j = 0;

  for(i=0;i<Word_Arr.length;i++)
  {
    if(Word_Arr[i] == Word){
      flag = 1;
      break;
    }
  }
  if(flag == 1){
    return i;
  }else{
    Word_Arr.push(Word);
    Count_Arr.push(0);
    var Arr = new Array();
    Embedding_Arr.push(Arr);
    Embedding_Arr[Embedding_Arr.length-1].push(0);

    for(j=0;j<Embedding_Arr.length;j++){
      Embedding_Arr[j].push(0);
      Embedding_Arr[Embedding_Arr.length-1].push(0);
    }

    return (Embedding_Arr.length-1);
  }
}

function init(){
  var Embedding_Array = new Array();
  var Word_Array = new Array();
  var Count_Array = new Array();
  var Window_Length = 2;

  client.query('SELECT * FROM A_Table',function(err,Answer_tbl){
    client.query('SELECT * FROM Q_Table',function(err,Table_res){

      mecab.parse(content, function(err, result) {
        var q_length = 0; // 비동기니까 잘 처리할 것.

        client.query('SELECT * FROM Count_Table',function(err,count_res){
          q_length = count_res[0].tot_q;
          if(system_mode == 2){
            for( var key in result ) {
              toStringRes += key + '['+result[key]+']\n';
            }
          }

          /*
            Word Embedding 2018.05.08 Sim Dae-Soo
          */
          console.log(" - Word Embedding is start!");
          var i = 0;
          var j = 0;
          var flag = 0;
          var arr_index = 0;
          var temp_index = 0;

          while(i < q_length)
          {
            word = Table_res[j].q_1;
            arr_index = getIndex(Word_Array,Count_Array,Embedding_Array,word);
            Count_Array[arr_index]++;
            temp_index = j - Window_Length;

            while(temp_index <= j + Window_Length)
            {
              if(temp_index == j || temp_index < 0 || Table_res[temp_index].q_index >= Table_res[j].q_length){
                temp_index++;
                break;
              }else if(Table_res[temp_index].id != Table_res[j].id){
                temp_index++;
                break;
              }else{
                var temp_word = Table_res[temp_index].q_1;
                var x = getIndex(Word_Array,Count_Array,Embedding_Array,temp_word);

                temp_word = Table_res[j].q_1;
                var y = getIndex(Word_Array,Count_Array,Embedding_Array,temp_word);

                Embedding_Array[x][y]++;
                temp_index++;
              }
            }

            j++;
            if(Table_res[i].id != Table_res[j].id){
              i++;
            }
          }
          console.log(" - Word Embedding is done!");
          console.log(Word_Array);
          console.log(Count_Array);
          console.log(Word_Array.length);
        });
      });
    });
  });

}


</script>
